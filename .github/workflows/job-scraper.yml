name: Automated Job Scraping

on:
  schedule:
    # 10am Israel time (UTC+2 = 8am UTC)
    - cron: '0 8 * * *'
    # 4pm Israel time (UTC+2 = 2pm UTC) 
    - cron: '0 14 * * *'
  workflow_dispatch: # Allow manual triggering for testing

jobs:
  scrape-jobs:
    runs-on: ubuntu-latest
    
    steps:
      - name: üïí Log Execution Time
        run: |
          echo "üöÄ Starting scheduled job scraping..."
          echo "Current UTC time: $(date -u)"
          echo "Israel time (approx): $(TZ='Asia/Jerusalem' date)"
      
      - name: üîç Trigger Job Scraping
        id: scrape
        run: |
          echo "Calling job scraping API..."
          echo "API URL: ${{ secrets.RENDER_APP_URL }}/api/jobs/scrape/system"
          
          response=$(curl -s -L -w "%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.SYSTEM_API_KEY }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Job-Scraper/1.0" \
            --connect-timeout 30 \
            --max-time 120 \
            -d '{}' \
            "${{ secrets.RENDER_APP_URL }}/api/jobs/scrape/system")
          
          http_code="${response: -3}"
          body="${response%???}"
          
          echo "HTTP Status: $http_code"
          echo "Response Body: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Job scraping completed successfully"
            echo "response_body=$body" >> $GITHUB_OUTPUT
          elif [ "$http_code" -eq 308 ] || [ "$http_code" -eq 301 ] || [ "$http_code" -eq 302 ]; then
            echo "üîÑ Redirect detected (Status $http_code). URL: $body"
            echo "‚ùå Please check your RENDER_APP_URL - it might be missing 'https://' or redirecting"
            exit 1
          else
            echo "‚ùå Job scraping failed with status $http_code"
            echo "Response: $body"
            
            # Debug information
            echo "Debug: Checking if secrets are set..."
            if [ -z "${{ secrets.RENDER_APP_URL }}" ]; then
              echo "‚ùå RENDER_APP_URL secret is not set!"
            else
              echo "‚úÖ RENDER_APP_URL is set"
            fi
            
            if [ -z "${{ secrets.SYSTEM_API_KEY }}" ]; then
              echo "‚ùå SYSTEM_API_KEY secret is not set!"
            else
              echo "‚úÖ SYSTEM_API_KEY is set (first 8 chars: ${SYSTEM_API_KEY:0:8}...)"
            fi
            
            exit 1
          fi
        env:
          SYSTEM_API_KEY: ${{ secrets.SYSTEM_API_KEY }}
      
      - name: üìä Log Results
        if: success()
        run: |
          echo "üìà Scraping Results:"
          echo "${{ steps.scrape.outputs.response_body }}" | python3 -m json.tool || echo "Response was not valid JSON"
          echo "‚ú® Scheduled job scraping completed successfully!"
      
      - name: üö® Handle Errors
        if: failure()
        run: |
          echo "üí• Scheduled job scraping failed!"
          echo "Please check your Render app logs for more details."
          echo "Make sure SYSTEM_API_KEY and RENDER_APP_URL are correctly configured."